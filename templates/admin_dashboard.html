{% extends "base.html" %} {% block title %}tryontrend - Admin Dashboard{%
endblock %} {% block additional_head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/admin.css') }}"
/>
<style>
  /* Additional styles for image display */
  .image-preview {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #e0e0e0;
    background-color: #f8f9fa;
  }

  .image-placeholder {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    color: #6c757d;
    font-size: 20px;
  }

  /* Analytics Dashboard Styles */
  .analytics-header {
    margin-bottom: 2.5rem;
  }
  
  .analytics-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 1.5rem 0;
  }
  
  .date-filter {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .date-filter label {
    margin-bottom: 0;
    font-weight: 500;
  }
  
  .date-filter .form-control {
    width: 150px;
  }
  
  .analytics-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }
  
  .metric-card {
    background-color: var(--card-bg);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-lighter);
    position: relative;
  }
  
  .metric-icon {
    width: 4rem;
    height: 4rem;
    border-radius: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin-bottom: 1rem;
    color: white;
  }
  
  .metric-value {
    font-size: 2.4rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  
  .metric-change {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    font-size: 1.2rem;
    font-weight: 600;
    padding: 0.2rem 0.8rem;
    border-radius: 1rem;
  }
  
  .metric-change.positive {
    background-color: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }
  
  .metric-change.negative {
    background-color: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }
  
  .analytics-charts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }
  
  .chart-container {
    background-color: var(--card-bg);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-lighter);
    height: 400px; /* Fixed height for chart containers */
    margin-bottom: 1.5rem;
  }
  
  .chart-container h4 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    font-weight: 600;
  }
  
  canvas {
    max-height: 330px; /* Constrain canvas height */
  }
  
  .analytics-section {
    background-color: var(--card-bg);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-lighter);
    margin-bottom: 2rem;
  }
  
  .analytics-section h4 {
    margin-bottom: 1rem;
    color: var(--text-primary);
    font-weight: 600;
  }
  
  @media (max-width: 768px) {
    .analytics-metrics {
      grid-template-columns: 1fr 1fr;
    }
    
    .analytics-charts {
      grid-template-columns: 1fr;
    }
    
    .analytics-actions {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }
  }
  
  @media (max-width: 576px) {
    .analytics-metrics {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="admin-container">
  <div class="admin-header">
    <div>
      <h1>Admin Dashboard</h1>
      <p>
        Welcome back, {{ current_user.username }}! Monitor and manage your
        tryontrend platform.
      </p>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="admin-stats">
    <div class="stat-card">
      <div class="stat-icon stat-users">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-value">{{ user_count }}</div>
      <div class="stat-label">Total Users</div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-tryons">
        <i class="fas fa-tshirt"></i>
      </div>
      <div class="stat-value">{{ tryon_count }}</div>
      <div class="stat-label">Total Try-Ons</div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-garments">
        <i class="fas fa-vest"></i>
      </div>
      <div class="stat-value">{{ garment_count }}</div>
      <div class="stat-label">Garments Tried</div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-api">
        <i class="fas fa-key"></i>
      </div>
      <div class="stat-value">{{ api_count }}</div>
      <div class="stat-label">API Keys Active</div>
    </div>
  </div>

  <!-- Admin Tabs -->
  <div class="admin-tabs">
    <ul class="nav-tabs" id="adminTabs">
      <li class="nav-item">
        <a
          class="nav-link active"
          id="users-tab"
          data-toggle="tab"
          href="#users"
        >
          <i class="fas fa-users"></i> Users
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="tryons-tab" data-toggle="tab" href="#tryons">
          <i class="fas fa-images"></i> Try-On History
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="api-tab" data-toggle="tab" href="#api">
          <i class="fas fa-key"></i> API Management
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="analytics-tab" data-toggle="tab" href="#analytics">
          <i class="fas fa-chart-bar"></i> Business Analytics
        </a>
      </li>
    </ul>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Users Tab -->
    <div class="tab-pane active" id="users">
      <div class="search-box">
        <input
          type="text"
          id="userSearchInput"
          placeholder="Search users by name or email"
        />
        <button id="userSearchBtn"><i class="fas fa-search"></i></button>
      </div>

      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>User</th>
              <th>Email</th>
              <th>Joined</th>
              <th>Try-Ons</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            {% for user in users %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
              <td>{{ user.try_on_count }}</td>
              <td>
                {% if user.is_active %}
                <span class="status-badge status-active">Active</span>
                {% else %}
                <span class="status-badge status-inactive">Blocked</span>
                {% endif %}
              </td>
              <td>
                <a
                  href="{{ url_for('admin_user_details', user_id=user.id) }}"
                  class="action-btn btn-view"
                >
                  <i class="fas fa-eye"></i> View
                </a>
                {% if user.is_active %}
                <button
                  class="action-btn btn-block toggle-user-btn"
                  data-user-id="{{ user.id }}"
                >
                  <i class="fas fa-ban"></i> Block
                </button>
                {% else %}
                <button
                  class="action-btn btn-block toggle-user-btn"
                  data-user-id="{{ user.id }}"
                >
                  <i class="fas fa-check"></i> Unblock
                </button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="page-item"><a class="page-link" href="#">Prev</a></div>
        <div class="page-item active"><a class="page-link" href="#">1</a></div>
        <div class="page-item"><a class="page-link" href="#">2</a></div>
        <div class="page-item"><a class="page-link" href="#">3</a></div>
        <div class="page-item"><a class="page-link" href="#">Next</a></div>
      </div>
    </div>

    <!-- Try-On History Tab -->
    <div class="tab-pane" id="tryons">
      <div class="search-box">
        <input
          type="text"
          id="tryonSearchInput"
          placeholder="Search by user or garment"
        />
        <button id="tryonSearchBtn"><i class="fas fa-search"></i></button>
      </div>

      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>User</th>
              <th>Person</th>
              <th>Garment</th>
              <th>Result</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tryonTableBody">
            {% for tryon in tryons %}
            <tr>
              <td>{{ tryon.id }}</td>
              <td>{{ tryon.user.username }}</td>
              <td>
                <div class="image-container">
                  <img
                    src="{{ url_for('serve_upload', filename=tryon.person_image_path) }}"
                    class="image-preview"
                    alt="Person"
                    onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\'image-placeholder\'><i class=\'fas fa-user\'></i></div>'"
                  />
                </div>
              </td>
              <td>
                <div class="image-container">
                  <img
                    src="{{ url_for('serve_upload', filename=tryon.garment_image_path) }}"
                    class="image-preview"
                    alt="Garment"
                    onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\'image-placeholder\'><i class=\'fas fa-tshirt\'></i></div>'"
                  />
                </div>
              </td>
              <td>
                <div class="image-container">
                  <img
                    src="{{ url_for('serve_result', filename=tryon.result_path) }}"
                    class="image-preview"
                    alt="Result"
                    onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\'image-placeholder\'><i class=\'fas fa-image\'></i></div>'"
                  />
                </div>
              </td>
              <td>{{ tryon.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>
                <a
                  href="{{ url_for('admin_tryon_details', tryon_id=tryon.id) }}"
                  class="action-btn btn-view"
                >
                  <i class="fas fa-eye"></i> View
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="page-item"><a class="page-link" href="#">Prev</a></div>
        <div class="page-item active"><a class="page-link" href="#">1</a></div>
        <div class="page-item"><a class="page-link" href="#">2</a></div>
        <div class="page-item"><a class="page-link" href="#">3</a></div>
        <div class="page-item"><a class="page-link" href="#">Next</a></div>
      </div>
    </div>

    <!-- API Management Tab -->
    <div class="tab-pane" id="api">
      <h3>API Keys</h3>
      <p>Manage API keys for your tryontrend platform integration.</p>

      <div class="api-key-container">
        <strong>Primary API Key:</strong>
        <div class="api-key">{{ primary_api_key }}</div>
        <button
          class="copy-btn"
          id="copyApiKeyBtn"
          data-api-key="{{ primary_api_key }}"
        >
          <i class="fas fa-copy"></i> Copy
        </button>
      </div>

      <form action="{{ url_for('admin_generate_api_key') }}" method="POST">
        <div style="display: flex; margin-bottom: 20px">
          <input
            type="text"
            name="key_name"
            placeholder="API Key Name"
            class="form-control"
            style="flex: 1; margin-right: 10px; padding: 10px"
          />
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus"></i> Generate New Key
          </button>
        </div>
      </form>

      <h3 class="mt-5">API Usage</h3>
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>User</th>
              <th>Endpoint</th>
              <th>Status</th>
              <th>Response Time</th>
            </tr>
          </thead>
          <tbody>
            {% for api_call in api_calls %}
            <tr>
              <td>{{ api_call.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
              <td>
                {{ api_call.user.username if api_call.user else 'Anonymous' }}
              </td>
              <td>{{ api_call.endpoint }}</td>
              <td>{{ api_call.status_code }}</td>
              <td>{{ api_call.response_time }}ms</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Business Analytics Tab -->
    <div class="tab-pane" id="analytics">
      <div class="analytics-header">
        <h3>Business Analytics Dashboard</h3>
        <p>Track user engagement, feature usage, and conversion metrics.</p>
        
        <div class="analytics-actions">
          <div class="date-filter">
            <label for="analytics-range">Time Range:</label>
            <select id="analytics-range" class="form-control">
              <option value="7">Last 7 Days</option>
              <option value="30" selected>Last 30 Days</option>
              <option value="90">Last 90 Days</option>
              <option value="365">Last Year</option>
              <option value="all">All Time</option>
            </select>
          </div>
          
          <a href="/admin/export-users" id="exportUsersBtn" class="btn btn-primary"><i class="fas fa-download"></i> Export User Emails</a>
        </div>
      </div>
      
      <!-- Key Metrics -->
      <div class="analytics-metrics">
        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #4361ee, #3a56d4);">
            <i class="fas fa-eye"></i>
          </div>
          <div class="metric-value" id="total-visits">{{ total_visits|default(0) }}</div>
          <div class="metric-label">Total Visits</div>
          <div class="metric-change positive" id="visits-change">+{{ visits_change|default(0) }}%</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #f72585, #e91e63);">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="metric-value" id="total-tryons">{{ tryon_count }}</div>
          <div class="metric-label">Virtual Try-Ons</div>
          <div class="metric-change positive" id="tryons-change">+{{ tryons_change|default(0) }}%</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #4cc9f0, #36b6e0);">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="metric-value" id="new-users">{{ new_users|default(0) }}</div>
          <div class="metric-label">New Users</div>
          <div class="metric-change positive" id="users-change">+{{ users_change|default(0) }}%</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <div class="metric-value" id="conversion-rate">{{ conversion_rate|default(0) }}%</div>
          <div class="metric-label">Conversion Rate</div>
          <div class="metric-change positive" id="conversion-change">+{{ conversion_change|default(0) }}%</div>
        </div>
      </div>
      
      <!-- Charts Section -->
      <div class="analytics-charts">
        <div class="chart-container">
          <h4>Visits Over Time</h4>
          <canvas id="visitsChart"></canvas>
        </div>
        
        <div class="chart-container">
          <h4>Feature Usage</h4>
          <canvas id="featureUsageChart"></canvas>
        </div>
      </div>
      
      <!-- User Activity Timeline -->
      <div class="analytics-section">
        <h4>User Activity Timeline</h4>
        <p>Detailed record of user interactions with the platform.</p>
        
        <div class="search-box">
          <input
            type="text"
            id="activitySearchInput"
            placeholder="Search by user or action"
          />
          <button id="activitySearchBtn"><i class="fas fa-search"></i></button>
        </div>
        
        <div class="table-responsive">
          <table class="data-table" id="activityTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Email</th>
                <th>Action</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="activityTableBody">
              {% for activity in user_activities|default([]) %}
              <tr>
                <td>{{ activity.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ activity.user.username if activity.user else 'Anonymous' }}</td>
                <td>{{ activity.user.email if activity.user else 'N/A' }}</td>
                <td>{{ activity.action }}</td>
                <td>{{ activity.details }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <div class="pagination">
          <div class="page-item"><a class="page-link" href="#">Prev</a></div>
          <div class="page-item active"><a class="page-link" href="#">1</a></div>
          <div class="page-item"><a class="page-link" href="#">2</a></div>
          <div class="page-item"><a class="page-link" href="#">3</a></div>
          <div class="page-item"><a class="page-link" href="#">Next</a></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for tab functionality -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Tab functionality
    const tabLinks = document.querySelectorAll(".nav-link");
    const tabPanes = document.querySelectorAll(".tab-pane");

    tabLinks.forEach((link) => {
      link.addEventListener("click", function (e) {
        e.preventDefault();

        // Remove active class from all tabs and panes
        tabLinks.forEach((tab) => tab.classList.remove("active"));
        tabPanes.forEach((pane) => pane.classList.remove("active"));

        // Add active class to current tab and pane
        this.classList.add("active");
        const tabId = this.getAttribute("href").substring(1);
        document.getElementById(tabId).classList.add("active");
      });
    });

    // Toggle user status functionality
    const toggleUserBtns = document.querySelectorAll(".toggle-user-btn");

    toggleUserBtns.forEach((button) => {
      button.addEventListener("click", function () {
        const userId = this.getAttribute("data-user-id");
        const isBlocked = this.innerHTML.includes("Unblock");

        if (
          confirm(
            `Are you sure you want to ${
              isBlocked ? "unblock" : "block"
            } this user?`
          )
        ) {
          fetch(`/admin/users/${userId}/toggle`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const row = this.closest("tr");
                const statusBadge = row.querySelector(".status-badge");

                if (isBlocked) {
                  this.innerHTML = '<i class="fas fa-ban"></i> Block';
                  statusBadge.className = "status-badge status-active";
                  statusBadge.innerText = "Active";
                } else {
                  this.innerHTML = '<i class="fas fa-check"></i> Unblock';
                  statusBadge.className = "status-badge status-inactive";
                  statusBadge.innerText = "Blocked";
                }
              } else {
                alert(data.message || "An error occurred");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred while processing your request");
            });
        }
      });
    });

    // Copy API Key functionality
    const copyApiKeyBtn = document.getElementById("copyApiKeyBtn");
    if (copyApiKeyBtn) {
      copyApiKeyBtn.addEventListener("click", function () {
        const apiKey = this.getAttribute("data-api-key");
        navigator.clipboard.writeText(apiKey).then(
          function () {
            // Change button text temporarily
            const originalText = copyApiKeyBtn.innerHTML;
            copyApiKeyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
              copyApiKeyBtn.innerHTML = originalText;
            }, 2000);
          },
          function () {
            alert("Failed to copy API key");
          }
        );
      });
    }

    // Search functionality
    const userSearchInput = document.getElementById("userSearchInput");
    const userSearchBtn = document.getElementById("userSearchBtn");

    if (userSearchInput && userSearchBtn) {
      userSearchBtn.addEventListener("click", filterUsers);
      userSearchInput.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          filterUsers();
        }
      });
    }

    function filterUsers() {
      const filter = userSearchInput.value.toUpperCase();
      const rows = document.querySelectorAll("#userTableBody tr");

      rows.forEach((row) => {
        const username = row.cells[1].textContent.toUpperCase();
        const email = row.cells[2].textContent.toUpperCase();

        if (username.includes(filter) || email.includes(filter)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }

    // Try-on search functionality
    const tryonSearchInput = document.getElementById("tryonSearchInput");
    const tryonSearchBtn = document.getElementById("tryonSearchBtn");

    if (tryonSearchInput && tryonSearchBtn) {
      tryonSearchBtn.addEventListener("click", filterTryons);
      tryonSearchInput.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          filterTryons();
        }
      });
    }

    function filterTryons() {
      const filter = tryonSearchInput.value.toUpperCase();
      const rows = document.querySelectorAll("#tryonTableBody tr");

      rows.forEach((row) => {
        const username = row.cells[1].textContent.toUpperCase();

        if (username.includes(filter)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }

    // Initial charts setup
    if (document.getElementById('visitsChart') && document.getElementById('featureUsageChart')) {
      setupCharts();
    }
    
    // Setup activity search functionality
    const activitySearchInput = document.getElementById("activitySearchInput");
    const activitySearchBtn = document.getElementById("activitySearchBtn");
    
    if (activitySearchInput && activitySearchBtn) {
      activitySearchBtn.addEventListener("click", filterActivity);
      activitySearchInput.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          filterActivity();
        }
      });
    }
    
    // Time range filter
    const analyticsRange = document.getElementById("analytics-range");
    if (analyticsRange) {
      analyticsRange.addEventListener("change", function() {
        fetchAnalyticsData(this.value);
      });
    }
    
    // Initial data load
    if (document.getElementById('analytics') && analyticsRange) {
      fetchAnalyticsData(30); // Default: 30 days
    }
  });
  
  function filterActivity() {
    const filter = document.getElementById("activitySearchInput").value.toUpperCase();
    const rows = document.querySelectorAll("#activityTableBody tr");
    
    rows.forEach((row) => {
      const username = row.cells[1].textContent.toUpperCase();
      const email = row.cells[2].textContent.toUpperCase();
      const action = row.cells[3].textContent.toUpperCase();
      
      if (username.includes(filter) || email.includes(filter) || action.includes(filter)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }
  
  function setupCharts() {
    // Visits Chart
    const visitsCtx = document.getElementById('visitsChart').getContext('2d');
    window.visitsChart = new Chart(visitsCtx, {
      type: 'line',
      data: {
        labels: [], // Will be populated in updateCharts
        datasets: [{
          label: 'Daily Visits',
          data: [],
          backgroundColor: 'rgba(67, 97, 238, 0.1)',
          borderColor: '#4361ee',
          borderWidth: 2,
          tension: 0.3,
          pointRadius: 3,
          pointBackgroundColor: '#4361ee',
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
    
    // Feature Usage Chart
    const featureUsageCtx = document.getElementById('featureUsageChart').getContext('2d');
    window.featureUsageChart = new Chart(featureUsageCtx, {
      type: 'bar',
      data: {
        labels: ['Try-On', 'Product View', 'Account Creation', 'Purchase', 'Shares'],
        datasets: [{
          label: 'Usage Count',
          data: [1280, 3560, 320, 150, 90],
          backgroundColor: [
            '#4361ee',
            '#f72585',
            '#4cc9f0',
            '#10b981',
            '#7209b7'
          ],
          borderRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  function fetchAnalyticsData(days) {
    // Make an AJAX call to get real data from backend
    fetch(`/admin/analytics/data?days=${days}`)
      .then(response => response.json())
      .then(data => {
        // Update metrics with real data
        if (document.getElementById("total-visits")) {
          document.getElementById("total-visits").textContent = data.visits.toLocaleString();
        }
        
        if (document.getElementById("total-tryons")) {
          document.getElementById("total-tryons").textContent = data.tryons.toLocaleString();
        }
        
        if (document.getElementById("new-users")) {
          document.getElementById("new-users").textContent = data.new_users.toLocaleString();
        }
        
        if (document.getElementById("conversion-rate")) {
          document.getElementById("conversion-rate").textContent = data.conversion_rate.toFixed(1);
        }
        
        // Update visit changes
        if (document.getElementById("visits-change")) {
          const visitsChange = document.getElementById("visits-change");
          visitsChange.textContent = (data.visits_change >= 0 ? '+' : '') + data.visits_change + '%';
          visitsChange.className = 'metric-change ' + (data.visits_change >= 0 ? 'positive' : 'negative');
        }
        
        // Update tryon changes
        if (document.getElementById("tryons-change")) {
          const tryonsChange = document.getElementById("tryons-change");
          tryonsChange.textContent = (data.tryons_change >= 0 ? '+' : '') + data.tryons_change + '%';
          tryonsChange.className = 'metric-change ' + (data.tryons_change >= 0 ? 'positive' : 'negative');
        }
        
        // Update user changes
        if (document.getElementById("users-change")) {
          const usersChange = document.getElementById("users-change");
          usersChange.textContent = (data.users_change >= 0 ? '+' : '') + data.users_change + '%';
          usersChange.className = 'metric-change ' + (data.users_change >= 0 ? 'positive' : 'negative');
        }
        
        // Update charts with real data
        updateChartsWithRealData(data);
      })
      .catch(error => {
        console.error('Error fetching analytics data:', error);
        // Fallback to mock data if API fails
        updateChartsWithMockData(days);
      });
  }
  
  function updateChartsWithRealData(data) {
    if (!window.visitsChart || !window.featureUsageChart) return;
    
    // Update visits chart with real data
    if (data.daily_visits) {
      const labels = data.daily_visits.map(item => item.date);
      const values = data.daily_visits.map(item => item.visits);
      
      window.visitsChart.data.labels = labels;
      window.visitsChart.data.datasets[0].data = values;
      window.visitsChart.update();
    }
    
    // Update feature usage chart with real data
    if (data.feature_usage) {
      window.featureUsageChart.data.datasets[0].data = [
        data.feature_usage.tryons || 0,
        data.feature_usage.product_views || 0,
        data.feature_usage.account_creation || 0,
        data.feature_usage.purchases || 0,
        data.feature_usage.shares || 0
      ];
      window.featureUsageChart.update();
    }
  }
  
  function updateChartsWithMockData(days) {
    if (!window.visitsChart || !window.featureUsageChart) return;
    
    // Generate mock data for charts
    const labels = [];
    const data = [];
    const currentDate = new Date();
    
    for (let i = days - 1; i >= 0; i--) {
      const date = new Date();
      date.setDate(currentDate.getDate() - i);
      
      // Format date as MM/DD
      const month = date.getMonth() + 1;
      const day = date.getDate();
      labels.push(`${month}/${day}`);
      
      // Generate random data
      let value;
      if (days <= 30) {
        value = Math.floor(Math.random() * 100) + 100;
      } else {
        const baseValue = 150;
        const trend = Math.sin(i / (days/5)) * 50; 
        const noise = Math.random() * 30 - 15;
        value = Math.floor(baseValue + trend + noise);
      }
      
      data.push(value);
    }
    
    // Update visits chart
    window.visitsChart.data.labels = labels;
    window.visitsChart.data.datasets[0].data = data;
    window.visitsChart.update();
    
    // Update feature usage chart
    const multiplier = days / 30;
    window.featureUsageChart.data.datasets[0].data = [
      Math.floor(1280 * multiplier),
      Math.floor(3560 * multiplier),
      Math.floor(320 * multiplier),
      Math.floor(150 * multiplier),
      Math.floor(90 * multiplier)
    ];
    window.featureUsageChart.update();
  }
</script>
{% endblock %}
